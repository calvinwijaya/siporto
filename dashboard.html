<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="assets/logo.png">
    <title>Dashboard SIPORTO</title>
    <script src="https://cdn.jsdelivr.net/npm/pizzip@3.1.5/dist/pizzip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docxtemplater@3.39.0/build/docxtemplater.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            min-height: 100vh;
            display: flex;
        }
        .sidebar {
            min-width: 250px;
            max-width: 350px;
            background-color: #0d6efd;
            color: white;
            transition: all 0.3s;
        }
        .sidebar.collapsed {
            min-width: 70px;
            max-width: 70px;
        }
        .sidebar .nav-link {
            color: white;
            white-space: nowrap;
        }
        .sidebar .nav-link:hover {
            background-color: rgba(255,255,255,0.2);
        }
        .sidebar .nav-link.active {
            background-color: rgba(255,255,255,0.3);
        }
        .sidebar .nav-link .label {
            transition: opacity 0.3s;
        }
        .sidebar.collapsed .nav-link .label {
            opacity: 0;
            pointer-events: none;
        }
        .sidebar .toggle-btn {
            cursor: pointer;
            padding: 10px;
            display: flex;
            justify-content: flex-end;
            color: white;
        }
        .sidebar.collapsed .toggle-btn {
            justify-content: center;
        }
        .content {
            flex: 1;
            padding: 20px;
            background-color: #f8f9fa;
            transition: margin-left 0.3s;
        }
        .nav-link.active {
            background-color: #0d6efd; /* Warna biru Bootstrap */
            color: white !important;
            border-radius: 5px;
        }
        .nav-link.active i {
            color: white !important;
        }
    </style>
</head>
<body>
    <div class="sidebar d-flex flex-column p-2" id="sidebar">
        <div class="toggle-btn" id="toggleSidebar">
            <i class="bi bi-list fs-4"></i>
        </div>
        <ul class="nav nav-pills flex-column mb-auto">
            <li>
                <a href="dashboard.html" class="nav-link">
                    <i class="bi bi-house me-2"></i>
                    <span class="label">Home</span>
                </a>
            </li>            
            <li>
                <a href="#" onclick="loadPage(event, 'buatporto/buatPorto.html','buatporto')" class="nav-link">
                    <i class="bi bi-plus-circle me-2"></i>
                    <span class="label">Buat Portofolio</span>
                </a>
            </li>
            <li>
                <a href="#" onclick="loadPage(event, 'rekapporto/rekapPorto.html','rekapporto')" class="nav-link">
                    <i class="bi bi-clipboard-data me-2"></i>
                    <span class="label">Rekapitulasi Portofolio</span>
                </a>
            </li>
            <li>
                <a href="#" onclick="loadPage(event, 'rekapmahasiswa/rekapMahasiswa.html','rekapmahasiswa')" class="nav-link">
                    <i class="bi bi-mortarboard me-2"></i>
                    <span class="label">Portofolio Mahasiswa</span>
                </a>
            </li>
            <li>
                <a class="nav-link dropdown-toggle" data-bs-toggle="collapse" href="#timeSeriesMenu" role="button" aria-expanded="false">
                    <i class="bi bi-clock-history me-2"></i>
                    <span class="label">Time Series</span>
                </a>
                <div class="collapse ps-3" id="timeSeriesMenu">
                    <ul class="nav flex-column">
                        <li><a href="#" onclick="loadPage(event, 'timeseries/timeSeriesProdi.html','timeseriesProdi')" class="nav-link">Time Series Prodi</a></li>
                        <li><a href="#" onclick="loadPage(event, 'timeseries/timeSeriesMK.html','timeseriesMK')" class="nav-link">Time Series MK</a></li>
                    </ul>
                </div>
            </li>
            <li><a href="#" class="nav-link" id="btnLogout"><i class="bi bi-box-arrow-right me-2"></i><span class="label">Log Out</span></a></li>
            <li><a href="https://ugm.id/mydtgd" class="nav-link" target="_blank" rel="noopener noreferrer"><i class="bi bi-grid-fill me-2"></i><span class="label">Ke myDTGD</span></a></li>
        </ul>
    </div>

    <!-- Content -->
    <div class="content">
        <div id="mainContent">
            <h1 class="display-4 fw-bold text-primary mb-0">SIPORTO</h1>
            <h4 class="text-secondary mt-2">Selamat Datang <span id="userNama" class="fw-semibold"></span></h4>
            <h5 class="text-muted mt-3">Sistem Portofolio Berbasis OBE</h5>
            <p class="text-muted">
                Dashboard ini merupakan sistem untuk mempermudah Dosen Departemen Teknik Geodesi Fakultas Teknik Universitas Gadjah Mada dalam melakukan pembuatan portofolio mata kuliah. 
                Sistem terintegrasi ke dalam basisdata dan tersimpan dengan sistematis. 
                <br><br><strong>Silakan pilih menu di sebelah kiri untuk membuat portofolio!</strong>
            </p>

            <!-- Grafik sekarang ada DI DALAM mainContent -->
            <!-- <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card shadow-sm p-3 mb-4" style="height: 400px;">
                        <canvas id="portoChart"></canvas>
                    </div>
                </div>
            </div> -->
        </div>
    </div>

    <div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9999; flex-direction: column; justify-content: center; align-items: center; color: white;">
        <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;"></div>
        <h5 class="fw-bold">Sedang Memproses...</h5>
        <p class="small">Mohon tunggu sebentar.</p>
    </div>

    <script>
        const user = JSON.parse(sessionStorage.getItem("user"));
        if (!user) {
            window.location.href = 'index.html';
        }
        document.getElementById("userNama").textContent = user.nama;
    </script>    
    <!-- <script src="grafik.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.getElementById('toggleSidebar').addEventListener('click', function () {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');

            // Tutup semua submenu ketika sidebar dicollapse
            if (sidebar.classList.contains('collapsed')) {
                document.querySelectorAll('.sidebar .collapse.show').forEach(el => {
                    const bsCollapse = bootstrap.Collapse.getInstance(el);
                    if (bsCollapse) {
                        bsCollapse.hide();
                    } else {
                        new bootstrap.Collapse(el, { toggle: false }).hide();
                    }
                });
            }
        });

        function loadPage(eventOrPage, pagePath, key) {
            let finalPage, finalKey;

            if (typeof eventOrPage === 'object' && eventOrPage !== null) {
                if (eventOrPage.preventDefault) eventOrPage.preventDefault();
                finalPage = pagePath;
                finalKey = key;
            } else {
                finalPage = eventOrPage;
                finalKey = pagePath;
            }

            if (!finalPage || !finalKey || finalKey === "undefined") return;

            fetch(finalPage)
                .then(res => {
                    if (!res.ok) throw new Error("Gagal mengambil file");
                    return res.text();
                })
                .then(html => {
                    document.getElementById("mainContent").innerHTML = html;

                    const newUrl = window.location.origin + window.location.pathname + `?page=${finalKey}`;
                    history.pushState({ page: finalPage, key: finalKey }, "", newUrl);

                    document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'))
                    const activeLink = document.querySelector(`a[onclick*="'${finalKey}'"]`);
                    if (activeLink) activeLink.classList.add('active');

                    if (finalKey === 'buatporto') {
                        loadScript('buatporto/buatPorto.js');
                    } if (finalKey === 'rekapporto') {
                        loadScript('rekapporto/rekapPorto.js');
                    } if (finalKey === 'rekapmahasiswa') {
                        loadScript('rekapmahasiswa/rekapMahasiswa.js');
                    } if (finalKey === 'timeseriesProdi') {
                        loadScript('timeseries/timeSeriesProdi.js');
                    } if (finalKey === 'timeseriesMK') {
                        loadScript('timeseries/timeSeriesMK.js');
                    }
                })
                .catch(err => {
                    console.error(err);
                    document.getElementById("mainContent").innerHTML = 
                        "<p class='text-danger'>Gagal memuat halaman.</p>";
                });
        }

        function loadScript(src) {
            const oldScript = document.querySelector(`script[src="${src}"]`);
            if (oldScript) {
                oldScript.remove(); // Hapus script lama jika ada
            }
            const script = document.createElement('script');
            script.src = src;
            script.async = true;
            document.body.appendChild(script);
        }

        // Menangani kondisi ketika user menekan tombol 'Back' atau 'Forward' di browser
        window.onpopstate = function(event) {
            if (event.state && event.state.page) {
                loadPage(event.state.page, event.state.key);
            } else {
                window.location.href = window.location.pathname; 
            }
        };

        document.addEventListener("DOMContentLoaded", () => {
            const params = new URLSearchParams(window.location.search);
            const pageKey = params.get("page");

            const routes = {
                'buatporto': 'buatporto/buatPorto.html',
                'rekapporto': 'rekapporto/rekapPorto.html',
                'rekapmahasiswa': 'rekapmahasiswa/rekapMahasiswa.html',
                'timeseriesProdi': 'timeseries/timeSeriesProdi.html',
                'timeseriesMK': 'timeseries/timeSeriesMK.html'
            };

            if (pageKey && routes[pageKey]) {
                loadPage(routes[pageKey], pageKey);
            }
        });
    </script>
    <script>
        document.getElementById("btnLogout").addEventListener("click", (e) => {
            e.preventDefault();

            Swal.fire({
                title: 'Keluar dari Sistem?',
                text: "Anda harus login kembali untuk mengakses data penilaian.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545', // Bootstrap Danger color
                cancelButtonColor: '#6c757d', // Bootstrap Secondary color
                confirmButtonText: 'Ya, Keluar',
                cancelButtonText: 'Batal',
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    performLogout();
                }
            });
        });

        function performLogout() {
            try {
                const userRaw = sessionStorage.getItem("user");
                const user = userRaw ? JSON.parse(userRaw) : null;
                const email = user?.email;

                if (window.google?.accounts?.id) {
                    google.accounts.id.disableAutoSelect();
                    if (email) {
                        google.accounts.id.revoke(email, () => {
                            console.log("Google session revoked");
                        });
                    }
                }
            } catch (err) {
                console.warn("Logout cleanup error:", err);
            }

            sessionStorage.clear();
            localStorage.clear();
            
            // Optional: Show a quick success message before redirecting
            Swal.fire({
                title: 'Berhasil Keluar',
                icon: 'success',
                timer: 1500,
                showConfirmButton: false
            }).then(() => {
                window.location.href = "login.html";
            });
        }
    </script>
    <script src="config.js"></script>
</body>
</html>